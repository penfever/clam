

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>clam.data.tsne_visualization &mdash; CLAM 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=b8215cab" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CLAM
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/quick-start.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/configuration.html">Configuration Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/vision/index.html">Vision Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/audio/index.html">Audio Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/tabular/index.html">Tabular Data Classification Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user-guide/api-models/index.html">API Models Integration Guide</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/basic-classification.html">Basic Classification Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/multi-modal-pipeline.html">Multi-Modal Pipeline Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/custom-datasets.html">Custom Datasets Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/clam.models.html">clam.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/clam.data.html">clam.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/clam.utils.html">clam.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api-reference/clam.viz.html">clam.viz</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Technical Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/resource-management.html">Resource Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/caching-system.html">Caching System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical-guides/evaluation-frameworks.html">Evaluation Frameworks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples &amp; Troubleshooting</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to CLAM</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CLAM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">clam.data.tsne_visualization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for clam.data.tsne_visualization</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">T-SNE visualization utilities for tabular data embeddings.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.manifold</span><span class="w"> </span><span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;create_tsne_visualization&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_tsne_3d_visualization&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_class_legend&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_combined_tsne_plot&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_combined_tsne_3d_plot&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_tsne_plot_with_knn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_tsne_3d_plot_with_knn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_regression_tsne_visualization&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_regression_tsne_3d_visualization&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_combined_regression_tsne_plot&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_combined_regression_tsne_3d_plot&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_regression_tsne_plot_with_knn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_regression_tsne_3d_plot_with_knn&#39;</span><span class="p">,</span>
    <span class="s1">&#39;encode_plot_as_base64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_distinct_colors&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_distinct_color_map&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_class_color_name_map&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_regression_color_map&#39;</span>
<span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="create_tsne_visualization">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_tsne_visualization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tsne_visualization</span><span class="p">(</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">perplexity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_3d</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create t-SNE visualization of train and test embeddings.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_embeddings: Training embeddings [n_train, embedding_dim]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        test_embeddings: Test embeddings [n_test, embedding_dim]</span>
<span class="sd">        test_labels: Optional test labels for validation [n_test]</span>
<span class="sd">        perplexity: t-SNE perplexity parameter</span>
<span class="sd">        n_iter: Number of t-SNE iterations</span>
<span class="sd">        random_state: Random seed for reproducibility</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        class_names: Optional class names for labeling</span>
<span class="sd">        use_semantic_names: Whether to use semantic class names</span>
<span class="sd">        use_3d: Whether to create 3D visualization (default: False for 2D)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        train_tsne: t-SNE coordinates for training data [n_train, 2 or 3]</span>
<span class="sd">        test_tsne: t-SNE coordinates for test data [n_test, 2 or 3]</span>
<span class="sd">        fig: Matplotlib figure object (2D or 3D depending on use_3d)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating t-SNE visualization with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> train and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> test samples&quot;</span><span class="p">)</span>
    
    <span class="c1"># Combine embeddings for joint t-SNE</span>
    <span class="n">combined_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_embeddings</span><span class="p">,</span> <span class="n">test_embeddings</span><span class="p">])</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Adjust perplexity if needed based on data size</span>
    <span class="n">effective_perplexity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">perplexity</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">effective_perplexity</span> <span class="o">!=</span> <span class="n">perplexity</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusting perplexity from </span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2"> due to small dataset size&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply t-SNE</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running t-SNE with perplexity=</span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2">, n_iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
        <span class="n">n_components</span><span class="o">=</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_3d</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">perplexity</span><span class="o">=</span><span class="n">effective_perplexity</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Suppress numerical warnings during t-SNE computation</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;sklearn.utils.extmath&quot;</span><span class="p">)</span>
        <span class="n">tsne_results</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Split back into train and test</span>
    <span class="n">train_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
    <span class="n">test_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    
    <span class="c1"># Create visualization - handle both 2D and 3D</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">use_3d</span><span class="p">:</span>
        <span class="c1"># Create 3D visualization with four different views</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="k">if</span> <span class="n">figsize</span> <span class="o">==</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">else</span> <span class="n">figsize</span><span class="p">)</span>
        
        <span class="c1"># Create four subplots for different 3D views</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
        <span class="c1"># View configurations: (elevation, azimuth, title)</span>
        <span class="n">views</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="s2">&quot;Isometric View&quot;</span><span class="p">),</span>  <span class="c1"># Default 3D view</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="s2">&quot;Front View (XZ)&quot;</span><span class="p">),</span>   <span class="c1"># Front view</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Side View (YZ)&quot;</span><span class="p">),</span>      <span class="c1"># Side view  </span>
            <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Top View (XY)&quot;</span><span class="p">)</span>       <span class="c1"># Top view</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">views</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
            
            <span class="c1"># Plot training points with colors</span>
            <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels</span> <span class="o">==</span> <span class="n">class_label</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                    <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">),</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">50</span>
                <span class="p">)</span>
            
            <span class="c1"># Plot test points in gray</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Only label once</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>  <span class="c1"># Square markers for test points</span>
            <span class="p">)</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 3&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
            
            <span class="c1"># Only show legend on first subplot</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D t-SNE Visualization: Training (Colored) vs Test (Gray) Data&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create 2D visualization</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        
        <span class="c1"># Plot training points with colors</span>
        <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels</span> <span class="o">==</span> <span class="n">class_label</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>
        
        <span class="c1"># Plot test points in gray</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>  <span class="c1"># Square markers for test points</span>
        <span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t-SNE Visualization: Training (Colored) vs Test (Gray) Data&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;3D&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_3d</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;2D&#39;</span><span class="si">}</span><span class="s2"> t-SNE visualization created successfully&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="create_tsne_3d_visualization">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_tsne_3d_visualization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tsne_3d_visualization</span><span class="p">(</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">perplexity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create 3D t-SNE visualization of train and test embeddings.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_embeddings: Training embeddings [n_train, embedding_dim]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        test_embeddings: Test embeddings [n_test, embedding_dim]</span>
<span class="sd">        test_labels: Optional test labels for validation [n_test]</span>
<span class="sd">        perplexity: t-SNE perplexity parameter</span>
<span class="sd">        n_iter: Number of t-SNE iterations</span>
<span class="sd">        random_state: Random seed for reproducibility</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        train_tsne: 3D t-SNE coordinates for training data [n_train, 3]</span>
<span class="sd">        test_tsne: 3D t-SNE coordinates for test data [n_test, 3]</span>
<span class="sd">        fig: Matplotlib figure object with 3D subplot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating 3D t-SNE visualization with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> train and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> test samples&quot;</span><span class="p">)</span>
    
    <span class="c1"># Combine embeddings for joint t-SNE</span>
    <span class="n">combined_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_embeddings</span><span class="p">,</span> <span class="n">test_embeddings</span><span class="p">])</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Adjust perplexity if needed based on data size</span>
    <span class="n">effective_perplexity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">perplexity</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">effective_perplexity</span> <span class="o">!=</span> <span class="n">perplexity</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusting perplexity from </span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2"> due to small dataset size&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply 3D t-SNE</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running 3D t-SNE with perplexity=</span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2">, n_iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
        <span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 3D instead of 2D</span>
        <span class="n">perplexity</span><span class="o">=</span><span class="n">effective_perplexity</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Suppress numerical warnings during t-SNE computation</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;sklearn.utils.extmath&quot;</span><span class="p">)</span>
        <span class="n">tsne_results</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Split back into train and test</span>
    <span class="n">train_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
    <span class="n">test_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    
    <span class="c1"># Create 3D visualization</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get unique classes and colors</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    <span class="n">class_color_names</span> <span class="o">=</span> <span class="n">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="c1"># Plot training points with colors</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels</span> <span class="o">==</span> <span class="n">class_label</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
            <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">),</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
        <span class="p">)</span>
    
    <span class="c1"># Plot test points in gray</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>  <span class="c1"># Square markers for test points</span>
    <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 3&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;3D t-SNE Visualization: Training (Colored) vs Test (Gray) Data&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;3D t-SNE visualization created successfully&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="get_distinct_colors">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.get_distinct_colors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_distinct_colors</span><span class="p">(</span><span class="n">n_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get distinct colors with semantic names for visualization.</span>
<span class="sd">    Generates additional colors programmatically if more than the predefined set are needed.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        n_classes: Number of distinct colors needed</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        List of (color_array, color_name) tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define a set of highly distinct colors with semantic names</span>
    <span class="n">base_distinct_colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.12</span><span class="p">,</span> <span class="mf">0.47</span><span class="p">,</span> <span class="mf">0.71</span><span class="p">]),</span> <span class="s2">&quot;Blue&quot;</span><span class="p">),</span>           <span class="c1"># Blue</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]),</span> <span class="s2">&quot;Orange&quot;</span><span class="p">),</span>         <span class="c1"># Orange  </span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.17</span><span class="p">]),</span> <span class="s2">&quot;Green&quot;</span><span class="p">),</span>          <span class="c1"># Green</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.84</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">]),</span> <span class="s2">&quot;Red&quot;</span><span class="p">),</span>            <span class="c1"># Red</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.58</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.74</span><span class="p">]),</span> <span class="s2">&quot;Purple&quot;</span><span class="p">),</span>         <span class="c1"># Purple</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.29</span><span class="p">]),</span> <span class="s2">&quot;Brown&quot;</span><span class="p">),</span>          <span class="c1"># Brown</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.89</span><span class="p">,</span> <span class="mf">0.47</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">]),</span> <span class="s2">&quot;Pink&quot;</span><span class="p">),</span>           <span class="c1"># Pink</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">]),</span> <span class="s2">&quot;Gray&quot;</span><span class="p">),</span>           <span class="c1"># Gray</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">]),</span> <span class="s2">&quot;Olive&quot;</span><span class="p">),</span>          <span class="c1"># Olive</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.09</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.81</span><span class="p">]),</span> <span class="s2">&quot;Cyan&quot;</span><span class="p">),</span>           <span class="c1"># Cyan</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">]),</span> <span class="s2">&quot;Yellow&quot;</span><span class="p">),</span>         <span class="c1"># Yellow</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">]),</span> <span class="s2">&quot;Violet&quot;</span><span class="p">),</span>         <span class="c1"># Violet</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">]),</span> <span class="s2">&quot;Navy&quot;</span><span class="p">),</span>           <span class="c1"># Navy</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">]),</span> <span class="s2">&quot;Crimson&quot;</span><span class="p">),</span>        <span class="c1"># Crimson</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">]),</span> <span class="s2">&quot;Dark Green&quot;</span><span class="p">),</span>     <span class="c1"># Dark Green</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">]),</span> <span class="s2">&quot;Gold&quot;</span><span class="p">),</span>           <span class="c1"># Gold</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">]),</span> <span class="s2">&quot;Indigo&quot;</span><span class="p">),</span>         <span class="c1"># Indigo</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">]),</span> <span class="s2">&quot;Coral&quot;</span><span class="p">),</span>          <span class="c1"># Coral</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">]),</span> <span class="s2">&quot;Teal&quot;</span><span class="p">),</span>           <span class="c1"># Teal</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">]),</span> <span class="s2">&quot;Lavender&quot;</span><span class="p">),</span>       <span class="c1"># Lavender</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">]),</span> <span class="s2">&quot;Lime&quot;</span><span class="p">),</span>           <span class="c1"># Lime</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.90</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">]),</span> <span class="s2">&quot;Tan&quot;</span><span class="p">),</span>            <span class="c1"># Tan</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.90</span><span class="p">]),</span> <span class="s2">&quot;Sky Blue&quot;</span><span class="p">),</span>       <span class="c1"># Sky Blue</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">]),</span> <span class="s2">&quot;Rose&quot;</span><span class="p">),</span>           <span class="c1"># Rose</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">]),</span> <span class="s2">&quot;Forest Green&quot;</span><span class="p">),</span>   <span class="c1"># Forest Green</span>
    <span class="p">]</span>
    
    <span class="n">colors_needed</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Use base colors first</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">n_classes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_distinct_colors</span><span class="p">))):</span>
        <span class="n">colors_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_distinct_colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="c1"># Generate additional colors if needed using HSV color space for maximum distinctness</span>
    <span class="k">if</span> <span class="n">n_classes</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_distinct_colors</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">colorsys</span>
        <span class="n">additional_needed</span> <span class="o">=</span> <span class="n">n_classes</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_distinct_colors</span><span class="p">)</span>
        
        <span class="c1"># Generate colors in HSV space with varied hue, saturation, and value</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">additional_needed</span><span class="p">):</span>
            <span class="c1"># Vary hue across the spectrum, with some saturation and value variation</span>
            <span class="n">hue</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mf">0.618033988749895</span><span class="p">)</span> <span class="o">%</span> <span class="mf">1.0</span>  <span class="c1"># Golden ratio for good distribution</span>
            <span class="n">saturation</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.15</span>  <span class="c1"># Vary between 0.6, 0.75, 0.9</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>  <span class="c1"># Vary between 0.7, 0.9</span>
            
            <span class="c1"># Convert HSV to RGB</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hsv_to_rgb</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">saturation</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">color_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgb</span><span class="p">)</span>
            <span class="n">color_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Color_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base_distinct_colors</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="n">colors_needed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">color_array</span><span class="p">,</span> <span class="n">color_name</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">colors_needed</span></div>



<div class="viewcode-block" id="create_distinct_color_map">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_distinct_color_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a color mapping using distinct, semantically named colors.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        unique_classes: Array of unique class labels</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping class labels to colors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distinct_colors</span> <span class="o">=</span> <span class="n">get_distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">))</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">):</span>
        <span class="n">color_array</span><span class="p">,</span> <span class="n">color_name</span> <span class="o">=</span> <span class="n">distinct_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_array</span>
    
    <span class="k">return</span> <span class="n">class_color_map</span></div>



<div class="viewcode-block" id="get_class_color_name_map">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.get_class_color_name_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a mapping from class labels to semantic color names.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        unique_classes: Array of unique class labels</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping class labels to color names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">distinct_colors</span> <span class="o">=</span> <span class="n">get_distinct_colors</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">))</span>
    <span class="n">class_name_map</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">):</span>
        <span class="n">color_array</span><span class="p">,</span> <span class="n">color_name</span> <span class="o">=</span> <span class="n">distinct_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">class_name_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_name</span>
    
    <span class="k">return</span> <span class="n">class_name_map</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Class&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format a class label consistently based on semantic names setting.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        class_label: The class index/label</span>
<span class="sd">        class_names: Optional list of semantic class names</span>
<span class="sd">        use_semantic_names: Whether to use semantic names</span>
<span class="sd">        prefix: Prefix for non-semantic format (e.g., &quot;Class&quot;, &quot;Training Class&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Formatted class label string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_semantic_names</span> <span class="ow">and</span> <span class="n">class_names</span> <span class="ow">and</span> <span class="n">class_label</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_label</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">class_label</span><span class="si">}</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="create_class_legend">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_class_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_class_legend</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a text legend describing class colors with both semantic names and RGB values.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        unique_classes: Array of unique class labels</span>
<span class="sd">        class_color_map: Dictionary mapping class labels to colors</span>
<span class="sd">        class_names: Optional list of semantic class names</span>
<span class="sd">        use_semantic_names: Whether to show semantic names in legend</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        legend_text: String description of the color legend</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">legend_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Class Legend:&quot;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]</span>
        
        <span class="c1"># Get RGB values</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rgb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  <span class="c1"># Default gray</span>
        
        <span class="c1"># Get semantic color name</span>
        <span class="n">color_name</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Find the closest semantic color name</span>
            <span class="n">color_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">distinct_colors</span> <span class="o">=</span> <span class="n">get_distinct_colors</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># Get all available colors</span>
            
            <span class="n">min_distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">color_ref</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">distinct_colors</span><span class="p">:</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">color_array</span> <span class="o">-</span> <span class="n">color_ref</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">:</span>
                    <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance</span>
                    <span class="n">color_name</span> <span class="o">=</span> <span class="n">name</span>
        
        <span class="c1"># Format class label consistently</span>
        <span class="k">if</span> <span class="n">use_semantic_names</span> <span class="ow">and</span> <span class="n">class_names</span> <span class="ow">and</span> <span class="n">class_label</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_names</span><span class="p">):</span>
            <span class="c1"># In semantic names mode, show only the semantic name</span>
            <span class="n">class_display</span> <span class="o">=</span> <span class="n">class_names</span><span class="p">[</span><span class="n">class_label</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_display</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="n">class_label</span><span class="si">}</span><span class="s2">&quot;</span>
            
        <span class="n">legend_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">class_display</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">color_name</span><span class="si">}</span><span class="s2"> RGB</span><span class="si">{</span><span class="n">rgb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">legend_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- Test points: Light Gray RGB(211, 211, 211)&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">legend_lines</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_combined_tsne_plot">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_combined_tsne_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_combined_tsne_plot</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_3d</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a t-SNE plot with optional highlighting of a specific test point.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: t-SNE coordinates for training data [n_train, 2 or 3]</span>
<span class="sd">        test_tsne: t-SNE coordinates for test data [n_test, 2 or 3]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight (optional)</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        zoom_factor: Zoom level (2.0 = 200% zoom, showing 50% of the range)</span>
<span class="sd">        class_names: Optional class names for labeling</span>
<span class="sd">        use_semantic_names: Whether to use semantic class names</span>
<span class="sd">        use_3d: Whether to create 3D visualization (default: False for 2D)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        fig: Matplotlib figure object (2D or 3D depending on use_3d)</span>
<span class="sd">        legend_text: Text description of the legend</span>
<span class="sd">        metadata: Dictionary with plot metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create figure and axis - handle both 2D and 3D</span>
    <span class="k">if</span> <span class="n">use_3d</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Get unique classes and create consistent color mapping</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    <span class="n">class_color_names</span> <span class="o">=</span> <span class="n">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="c1"># Apply zoom if highlighting a test point</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># Get the target point coordinates</span>
        <span class="n">target_point</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate the visible range based on zoom factor</span>
        <span class="c1"># zoom_factor = 2.0 means we show 1/2 of the original range</span>
        <span class="n">visible_fraction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        
        <span class="c1"># Get original data ranges</span>
        <span class="n">all_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">])</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># peak-to-peak (max - min)</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Calculate zoom window</span>
        <span class="n">x_window</span> <span class="o">=</span> <span class="n">x_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        
        <span class="c1"># Set axis limits centered on target point</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># For 3D, also handle z-axis</span>
        <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="n">train_tsne</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">z_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
            <span class="n">z_window</span> <span class="o">=</span> <span class="n">z_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
            <span class="n">z_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">z_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="c1"># Filter points to only show those within the zoom window (3D)</span>
            <span class="n">train_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                         <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                         <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
            <span class="n">test_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                        <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                        <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Filter points to only show those within the zoom window (2D)</span>
            <span class="n">train_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                         <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">))</span>
            <span class="n">test_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                        <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">))</span>
        
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">test_mask</span><span class="p">]</span>
        
        <span class="c1"># Set axis limits</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;set_zlim&#39;</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No zoom, show all points</span>
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span>
    
    <span class="c1"># Plot training points with colors (only visible ones)</span>
    <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels_visible</span> <span class="o">==</span> <span class="n">class_label</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>  <span class="c1"># Only plot if there are points of this class in view</span>
            <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="n">train_tsne_visible</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                    <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">,</span> <span class="s2">&quot;Training Class&quot;</span><span class="p">),</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">50</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                    <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">,</span> <span class="s2">&quot;Training Class&quot;</span><span class="p">),</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
                <span class="p">)</span>
    
    <span class="c1"># Plot all test points in gray (only visible ones)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="n">test_tsne_visible</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span>
            <span class="p">)</span>
    
    <span class="c1"># Highlight specific test point if requested</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="n">test_tsne</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point (Red Star)&#39;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point (Red Star)&#39;</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_3d</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;set_zlabel&#39;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 3&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-SNE Visualization - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1"> (Zoom: </span><span class="si">{</span><span class="n">zoom_factor</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">x)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-SNE Visualization - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t-SNE Visualization - Training vs Test Data&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Create legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="n">create_class_legend</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_train_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_test_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_classes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">),</span>
        <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="n">unique_classes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;highlighted_point&#39;</span><span class="p">:</span> <span class="n">highlight_test_idx</span><span class="p">,</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span> <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;n_visible_train&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;train_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_visible_test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;test_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="create_combined_tsne_3d_plot">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_combined_tsne_3d_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_combined_tsne_3d_plot</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="n">viewing_angles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create multiple 3D t-SNE plots with different viewing angles for comprehensive spatial understanding.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: 3D t-SNE coordinates for training data [n_train, 3]</span>
<span class="sd">        test_tsne: 3D t-SNE coordinates for test data [n_test, 3]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight (optional)</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        viewing_angles: List of (elevation, azimuth) tuples for different views</span>
<span class="sd">        zoom_factor: Zoom level (2.0 = 200% zoom, showing 50% of the range)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        fig: Matplotlib figure object with multiple 3D subplots</span>
<span class="sd">        legend_text: Text description of the legend</span>
<span class="sd">        metadata: Dictionary with plot metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">viewing_angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default viewing angles: front, side, top, and isometric views</span>
        <span class="n">viewing_angles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>   <span class="c1"># Isometric view</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>     <span class="c1"># Front view (XZ plane)</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>    <span class="c1"># Side view (YZ plane)</span>
            <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># Top view (XY plane)</span>
        <span class="p">]</span>
    
    <span class="c1"># Create subplots for multiple views</span>
    <span class="n">n_views</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Get unique classes and create consistent color mapping</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    <span class="n">class_color_names</span> <span class="o">=</span> <span class="n">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="c1"># Apply zoom if highlighting a test point</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># Get the target point coordinates</span>
        <span class="n">target_point</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate the visible range based on zoom factor</span>
        <span class="n">visible_fraction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        
        <span class="c1"># Get original data ranges</span>
        <span class="n">all_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">])</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">z_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Calculate zoom window</span>
        <span class="n">x_window</span> <span class="o">=</span> <span class="n">x_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">z_window</span> <span class="o">=</span> <span class="n">z_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        
        <span class="c1"># Set axis limits centered on target point</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">z_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">z_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Filter points to only show those within the zoom window</span>
        <span class="n">train_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                     <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
        <span class="n">test_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                    <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
        
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">test_mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No zoom, show all points</span>
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">z_min</span> <span class="o">=</span> <span class="n">z_max</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">view_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Isometric View&#39;</span><span class="p">,</span> <span class="s1">&#39;Front View (XZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Side View (YZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Top View (XY)&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot training points with colors (only visible ones)</span>
        <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels_visible</span> <span class="o">==</span> <span class="n">class_label</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>  <span class="c1"># Only plot if there are points of this class in view</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                    <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">,</span> <span class="s2">&quot;Training Class&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Only show legend on first plot</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
                <span class="p">)</span>
        
        <span class="c1"># Plot all test points in gray (only visible ones)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Only show legend on first plot</span>
            <span class="p">)</span>
        
        <span class="c1"># Highlight specific test point if requested</span>
        <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># Only show legend on first plot</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
        
        <span class="c1"># Set viewing angle</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
        
        <span class="c1"># Set axis limits if zoomed</span>
        <span class="k">if</span> <span class="n">x_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
        
        <span class="c1"># Labels and title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 1&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 2&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 3&#39;</span><span class="p">)</span>
        
        <span class="c1"># Use shorter view names if available</span>
        <span class="n">view_name</span> <span class="o">=</span> <span class="n">view_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_names</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;View </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1"> - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1"> (Zoom: </span><span class="si">{</span><span class="n">zoom_factor</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">x)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1"> - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Only add legend to the first subplot to avoid clutter</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Create legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="n">create_class_legend</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
    <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">This visualization shows </span><span class="si">{</span><span class="n">n_views</span><span class="si">}</span><span class="s2"> different viewing angles of the same 3D t-SNE space:&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">):</span>
        <span class="n">view_name</span> <span class="o">=</span> <span class="n">view_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_names</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;View </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- </span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s2">: Elevation=</span><span class="si">{</span><span class="n">elev</span><span class="si">}</span><span class="s2">°, Azimuth=</span><span class="si">{</span><span class="n">azim</span><span class="si">}</span><span class="s2">°&quot;</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_train_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_test_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_classes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">),</span>
        <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="n">unique_classes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;highlighted_point&#39;</span><span class="p">:</span> <span class="n">highlight_test_idx</span><span class="p">,</span>
        <span class="s1">&#39;viewing_angles&#39;</span><span class="p">:</span> <span class="n">viewing_angles</span><span class="p">,</span>
        <span class="s1">&#39;n_views&#39;</span><span class="p">:</span> <span class="n">n_views</span><span class="p">,</span>
        <span class="s1">&#39;is_3d&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span> <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;n_visible_train&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;train_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_visible_test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;test_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="create_tsne_plot_with_knn">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_tsne_plot_with_knn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tsne_plot_with_knn</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a 2D t-SNE plot with KNN pie chart showing neighbor class distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: 2D t-SNE coordinates for training data [n_train, 2]</span>
<span class="sd">        test_tsne: 2D t-SNE coordinates for test data [n_test, 2]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        train_embeddings: Original training embeddings for KNN [n_train, embedding_dim]</span>
<span class="sd">        test_embeddings: Original test embeddings for KNN [n_test, embedding_dim]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight and show KNN pie chart</span>
<span class="sd">        k: Number of nearest neighbors to analyze</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        zoom_factor: Zoom level (2.0 = 200% zoom, showing 50% of the range)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        fig: Matplotlib figure object</span>
<span class="sd">        legend_text: Text description of the legend</span>
<span class="sd">        metadata: Dictionary with plot metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create figure with subplot for main plot and optional pie chart</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="c1"># Create a grid: main plot takes ~70% width, pie chart takes ~30% width</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># Main plot spans first 3 columns</span>
        <span class="n">ax_pie</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span>  <span class="c1"># Pie chart spans last 2 columns (bigger)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax_pie</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Get unique classes and create consistent color mapping</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    <span class="n">class_color_names</span> <span class="o">=</span> <span class="n">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="c1"># Apply zoom if highlighting a test point</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># Get the target point coordinates</span>
        <span class="n">target_point</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate the visible range based on zoom factor</span>
        <span class="n">visible_fraction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        
        <span class="c1"># Get original data ranges</span>
        <span class="n">all_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">])</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># Calculate zoom window</span>
        <span class="n">x_window</span> <span class="o">=</span> <span class="n">x_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        
        <span class="c1"># Set axis limits centered on target point</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Filter points to only show those within the zoom window</span>
        <span class="n">train_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                     <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">))</span>
        <span class="n">test_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                    <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">))</span>
        
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">test_mask</span><span class="p">]</span>
        
        <span class="c1"># Set axis limits</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No zoom, show all points</span>
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span>
    
    <span class="c1"># Plot training points with colors (only visible ones)</span>
    <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels_visible</span> <span class="o">==</span> <span class="n">class_label</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                <span class="n">label</span><span class="o">=</span><span class="n">format_class_label</span><span class="p">(</span><span class="n">class_label</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">,</span> <span class="s2">&quot;Training Class&quot;</span><span class="p">),</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>
    
    <span class="c1"># Plot all test points in gray (only visible ones)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span>
        <span class="p">)</span>
    
    <span class="c1"># If highlighting a specific test point, show KNN connections</span>
    <span class="n">knn_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">):</span>
        <span class="c1"># Import KNN utilities</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">clam.models.knn_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_knn_in_embedding_space</span>
        
        <span class="c1"># Find KNN for this specific test point</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">test_embeddings</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">:</span><span class="n">highlight_test_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">find_knn_in_embedding_space</span><span class="p">(</span>
            <span class="n">train_embeddings</span><span class="p">,</span> <span class="n">query_embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span>
        <span class="p">)</span>
        
        <span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Get neighbors for the single query point</span>
        <span class="n">neighbor_distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Highlight the query point with a prominent marker</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point (Red Star)&#39;</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        
        <span class="c1"># Create KNN pie chart in the side panel</span>
        <span class="k">if</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">neighbor_classes</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">neighbor_indices</span><span class="p">]</span>
            <span class="n">knn_description</span> <span class="o">=</span> <span class="n">create_knn_pie_chart</span><span class="p">(</span>
                <span class="n">neighbor_classes</span><span class="p">,</span> <span class="n">neighbor_distances</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_color_names</span><span class="p">,</span> <span class="n">ax_pie</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span>
            <span class="p">)</span>
        
        <span class="c1"># Store KNN information for metadata</span>
        <span class="n">knn_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;neighbor_indices&#39;</span><span class="p">:</span> <span class="n">neighbor_indices</span><span class="p">,</span>
            <span class="s1">&#39;neighbor_distances&#39;</span><span class="p">:</span> <span class="n">neighbor_distances</span><span class="p">,</span>
            <span class="s1">&#39;neighbor_classes&#39;</span><span class="p">:</span> <span class="n">neighbor_classes</span><span class="p">,</span>
            <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s1">&#39;knn_description&#39;</span><span class="p">:</span> <span class="n">knn_description</span> <span class="k">if</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">}</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-SNE with KNN Analysis - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1"> (Zoom: </span><span class="si">{</span><span class="n">zoom_factor</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">x)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;t-SNE with KNN Analysis - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t-SNE Visualization - Training vs Test Data&#39;</span><span class="p">)</span>
    
    <span class="c1"># Position legend differently based on whether we have a pie chart</span>
    <span class="k">if</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Apply layout - use GridSpec layout if we have pie chart, otherwise tight_layout</span>
    <span class="k">if</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Manually adjust spacing for GridSpec layout with larger pie chart</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.92</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Create enhanced legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="n">create_class_legend</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">knn_info</span> <span class="ow">and</span> <span class="s1">&#39;knn_description&#39;</span> <span class="ow">in</span> <span class="n">knn_info</span> <span class="ow">and</span> <span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;knn_description&#39;</span><span class="p">]:</span>
        <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;knn_description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_train_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_test_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_classes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">),</span>
        <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="n">unique_classes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;highlighted_point&#39;</span><span class="p">:</span> <span class="n">highlight_test_idx</span><span class="p">,</span>
        <span class="s1">&#39;knn_info&#39;</span><span class="p">:</span> <span class="n">knn_info</span><span class="p">,</span>
        <span class="s1">&#39;has_knn_pie_chart&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">knn_info</span> <span class="ow">and</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span> <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;n_visible_train&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;train_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_visible_test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;test_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">create_knn_pie_chart</span><span class="p">(</span>
    <span class="n">neighbor_classes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">neighbor_distances</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">class_color_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">class_color_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">ax_pie</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">max_pie_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a pie chart showing KNN class distribution with distance-based sizing.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        neighbor_classes: Classes of the k nearest neighbors</span>
<span class="sd">        neighbor_distances: Distances to the k nearest neighbors</span>
<span class="sd">        class_color_map: Mapping from class labels to colors</span>
<span class="sd">        class_color_names: Mapping from class labels to color names</span>
<span class="sd">        ax_pie: Matplotlib axes for the pie chart</span>
<span class="sd">        k: Number of nearest neighbors</span>
<span class="sd">        max_pie_classes: Maximum number of classes to show in pie chart (default: 10)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Description text for the pie chart</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Count neighbors by class</span>
    <span class="n">unique_classes_knn</span><span class="p">,</span> <span class="n">class_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">neighbor_classes</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Calculate average distance for each class</span>
    <span class="n">class_avg_distances</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">unique_classes_knn</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">neighbor_classes</span> <span class="o">==</span> <span class="bp">cls</span>
        <span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">neighbor_distances</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
    
    <span class="c1"># Limit to top N classes by count (most represented neighbors)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes_knn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pie_classes</span><span class="p">:</span>
        <span class="c1"># Sort by count (descending) and take top (max_pie_classes - 1) to leave room for &quot;Other&quot;</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">max_pie_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">unique_classes_knn</span> <span class="o">=</span> <span class="n">unique_classes_knn</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
        <span class="n">class_counts</span> <span class="o">=</span> <span class="n">class_counts</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
        
        <span class="c1"># Update class_avg_distances to only include top classes</span>
        <span class="n">class_avg_distances</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">unique_classes_knn</span><span class="p">}</span>
        
        <span class="c1"># Calculate count of remaining classes for &quot;Other&quot; category</span>
        <span class="n">other_count</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">class_counts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Add &quot;Other&quot; category</span>
            <span class="n">unique_classes_knn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_classes_knn</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Use -1 as &quot;Other&quot; class ID</span>
            <span class="n">class_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_counts</span><span class="p">,</span> <span class="n">other_count</span><span class="p">)</span>
            <span class="n">class_avg_distances</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">class_avg_distances</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    
    <span class="c1"># Prepare data for pie chart</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes_knn</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">class_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># &quot;Other&quot; category</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Other</span><span class="se">\n</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\n</span><span class="s1">AvgDist: </span><span class="si">{</span><span class="n">avg_dist</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_color_map</span><span class="p">[</span><span class="bp">cls</span><span class="p">])</span>
            <span class="n">color_name</span> <span class="o">=</span> <span class="n">class_color_names</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
            <span class="n">class_label</span> <span class="o">=</span> <span class="n">format_class_label</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">class_label</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\n</span><span class="s1">AvgDist: </span><span class="si">{</span><span class="n">avg_dist</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create pie chart with distance-based &quot;explosion&quot; (larger radius for closer points)</span>
    <span class="n">max_dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">class_avg_distances</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">min_dist</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">class_avg_distances</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    
    <span class="c1"># Calculate explosion values (closer points = larger explosion = more prominent)</span>
    <span class="k">if</span> <span class="n">max_dist</span> <span class="o">&gt;</span> <span class="n">min_dist</span><span class="p">:</span>
        <span class="n">explode</span> <span class="o">=</span> <span class="p">[(</span><span class="n">max_dist</span> <span class="o">-</span> <span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_dist</span> <span class="o">-</span> <span class="n">min_dist</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> 
                  <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">unique_classes_knn</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">explode</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes_knn</span><span class="p">)</span>  <span class="c1"># Small uniform explosion if all distances equal</span>
    
    <span class="c1"># Create the pie chart with better spacing</span>
    <span class="n">wedges</span><span class="p">,</span> <span class="n">texts</span><span class="p">,</span> <span class="n">autotexts</span> <span class="o">=</span> <span class="n">ax_pie</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span>
        <span class="n">class_counts</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># We&#39;ll handle percentages in labels</span>
        <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
        <span class="n">explode</span><span class="o">=</span><span class="n">explode</span><span class="p">,</span>
        <span class="n">textprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;normal&#39;</span><span class="p">},</span>  <span class="c1"># Smaller, normal weight text</span>
        <span class="n">wedgeprops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">},</span>  <span class="c1"># Thinner edge lines</span>
        <span class="n">labeldistance</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span>  <span class="c1"># Move labels further outward</span>
        <span class="n">pctdistance</span><span class="o">=</span><span class="mf">0.85</span>    <span class="c1"># Keep any percentage text closer to center</span>
    <span class="p">)</span>
    
    <span class="c1"># Update title to show if classes were limited</span>
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;K-NN Distribution (k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">neighbor_classes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max_pie_classes</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; (Top </span><span class="si">{</span><span class="n">max_pie_classes</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="n">ax_pie</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    
    <span class="c1"># Ensure pie chart is circular and well-positioned</span>
    <span class="n">ax_pie</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    
    <span class="c1"># Adjust text positioning to reduce overlap</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set_horizontalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">set_verticalalignment</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create description text</span>
    <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;K-NN Analysis (k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">):</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_classes_knn</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">class_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">avg_dist</span> <span class="o">=</span> <span class="n">class_avg_distances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">cls</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># &quot;Other&quot; category</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• Other: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> neighbors (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%), AvgDist: </span><span class="si">{</span><span class="n">avg_dist</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_name</span> <span class="o">=</span> <span class="n">class_color_names</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
            <span class="n">class_label</span> <span class="o">=</span> <span class="n">format_class_label</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
            <span class="n">description</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• </span><span class="si">{</span><span class="n">class_label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> neighbors (</span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">%), AvgDist: </span><span class="si">{</span><span class="n">avg_dist</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    
    <span class="k">return</span> <span class="n">description</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<div class="viewcode-block" id="create_tsne_3d_plot_with_knn">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_tsne_3d_plot_with_knn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tsne_3d_plot_with_knn</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
    <span class="n">viewing_angles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">class_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_semantic_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create multiple 3D t-SNE plots with KNN pie chart from different viewing angles.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: 3D t-SNE coordinates for training data [n_train, 3]</span>
<span class="sd">        test_tsne: 3D t-SNE coordinates for test data [n_test, 3]</span>
<span class="sd">        train_labels: Training labels [n_train]</span>
<span class="sd">        train_embeddings: Original training embeddings for KNN [n_train, embedding_dim]</span>
<span class="sd">        test_embeddings: Original test embeddings for KNN [n_test, embedding_dim]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight and show KNN pie chart</span>
<span class="sd">        k: Number of nearest neighbors to analyze</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        viewing_angles: List of (elevation, azimuth) tuples for different views</span>
<span class="sd">        zoom_factor: Zoom level (2.0 = 200% zoom, showing 50% of the range)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        fig: Matplotlib figure object with multiple 3D subplots</span>
<span class="sd">        legend_text: Text description of the legend</span>
<span class="sd">        metadata: Dictionary with plot metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">viewing_angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default viewing angles: front, side, top, and isometric views</span>
        <span class="n">viewing_angles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>   <span class="c1"># Isometric view</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>     <span class="c1"># Front view (XZ plane)</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>    <span class="c1"># Side view (YZ plane)</span>
            <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>    <span class="c1"># Top view (XY plane)</span>
        <span class="p">]</span>
    
    <span class="c1"># Create subplots for multiple views plus optional pie chart</span>
    <span class="n">n_views</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># If highlighting a point, reserve space for KNN pie chart</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create grid: 2x4 layout with pie chart taking 2 columns in bottom right</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                             <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
        <span class="n">ax_pie</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:])</span>  <span class="c1"># Bottom right 2 columns for bigger pie chart</span>
        <span class="n">view_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>  <span class="c1"># First 4 positions for 3D views</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard 2x2 grid for 4 views</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">ax_pie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">view_positions</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
    
    <span class="c1"># Get unique classes and create consistent color mapping</span>
    <span class="n">unique_classes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_labels</span><span class="p">)</span>
    <span class="n">class_color_map</span> <span class="o">=</span> <span class="n">create_distinct_color_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    <span class="n">class_color_names</span> <span class="o">=</span> <span class="n">get_class_color_name_map</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">)</span>
    
    <span class="n">view_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Isometric View&#39;</span><span class="p">,</span> <span class="s1">&#39;Front View (XZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Side View (YZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Top View (XY)&#39;</span><span class="p">]</span>
    
    <span class="c1"># Find KNN for the highlighted test point if specified</span>
    <span class="n">knn_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">clam.models.knn_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_knn_in_embedding_space</span>
        
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">test_embeddings</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">:</span><span class="n">highlight_test_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">find_knn_in_embedding_space</span><span class="p">(</span>
            <span class="n">train_embeddings</span><span class="p">,</span> <span class="n">query_embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span>
        <span class="p">)</span>
        
        <span class="n">neighbor_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighbor_distances</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">neighbor_classes</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">neighbor_indices</span><span class="p">]</span>
        
        <span class="n">knn_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;neighbor_indices&#39;</span><span class="p">:</span> <span class="n">neighbor_indices</span><span class="p">,</span>
            <span class="s1">&#39;neighbor_distances&#39;</span><span class="p">:</span> <span class="n">neighbor_distances</span><span class="p">,</span>
            <span class="s1">&#39;neighbor_classes&#39;</span><span class="p">:</span> <span class="n">neighbor_classes</span><span class="p">,</span>
            <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span>
        <span class="p">}</span>
    
    <span class="c1"># Apply zoom if highlighting a test point</span>
    <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">highlight_test_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="ow">and</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># Get the target point coordinates</span>
        <span class="n">target_point</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate the visible range based on zoom factor</span>
        <span class="n">visible_fraction</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        
        <span class="c1"># Get original data ranges</span>
        <span class="n">all_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">])</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">z_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">all_points</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># Calculate zoom window</span>
        <span class="n">x_window</span> <span class="o">=</span> <span class="n">x_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">y_window</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        <span class="n">z_window</span> <span class="o">=</span> <span class="n">z_range</span> <span class="o">*</span> <span class="n">visible_fraction</span>
        
        <span class="c1"># Set axis limits centered on target point</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">z_min</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">z_max</span> <span class="o">=</span> <span class="n">target_point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">z_window</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Filter points to only show those within the zoom window</span>
        <span class="n">train_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                     <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                     <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
        <span class="n">test_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x_max</span><span class="p">)</span> <span class="o">&amp;</span> 
                    <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">y_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">z_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">z_max</span><span class="p">))</span>
        
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">[</span><span class="n">train_mask</span><span class="p">]</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">test_mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No zoom, show all points</span>
        <span class="n">train_tsne_visible</span> <span class="o">=</span> <span class="n">train_tsne</span>
        <span class="n">train_labels_visible</span> <span class="o">=</span> <span class="n">train_labels</span>
        <span class="n">test_tsne_visible</span> <span class="o">=</span> <span class="n">test_tsne</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">y_min</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">z_min</span> <span class="o">=</span> <span class="n">z_max</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">):</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">view_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot training points with colors (only visible ones)</span>
        <span class="k">for</span> <span class="n">class_label</span> <span class="ow">in</span> <span class="n">unique_classes</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">train_labels_visible</span> <span class="o">==</span> <span class="n">class_label</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne_visible</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">class_color_map</span><span class="p">[</span><span class="n">class_label</span><span class="p">]],</span> 
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Training Class </span><span class="si">{</span><span class="n">class_label</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
                <span class="p">)</span>
        
        <span class="c1"># Plot all test points in gray (only visible ones)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne_visible</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>
        
        <span class="c1"># Highlight specific test point for KNN analysis</span>
        <span class="k">if</span> <span class="n">knn_info</span><span class="p">:</span>
            <span class="c1"># Highlight the query point with a prominent marker</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span>
            <span class="p">)</span>
        
        <span class="c1"># Set viewing angle</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
        
        <span class="c1"># Set axis limits if zoomed</span>
        <span class="k">if</span> <span class="n">x_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span><span class="p">)</span>
        
        <span class="c1"># Labels and title</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 1&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 2&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 3&#39;</span><span class="p">)</span>
        
        <span class="c1"># Use shorter view names if available</span>
        <span class="n">view_name</span> <span class="o">=</span> <span class="n">view_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_names</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;View </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1"> - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1"> + KNN (Zoom: </span><span class="si">{</span><span class="n">zoom_factor</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">x)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1"> - Query Point </span><span class="si">{</span><span class="n">highlight_test_idx</span><span class="si">}</span><span class="s1"> + KNN&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># Only add legend to the first subplot to avoid clutter</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create KNN pie chart if we have KNN info and ax_pie</span>
    <span class="n">knn_description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">knn_info</span> <span class="ow">and</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">knn_description</span> <span class="o">=</span> <span class="n">create_knn_pie_chart</span><span class="p">(</span>
            <span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;neighbor_classes&#39;</span><span class="p">],</span> <span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;neighbor_distances&#39;</span><span class="p">],</span> 
            <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_color_names</span><span class="p">,</span> <span class="n">ax_pie</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span>
        <span class="p">)</span>
        <span class="c1"># Update KNN info with the description</span>
        <span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;knn_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">knn_description</span>
    
    <span class="c1"># Apply layout - use GridSpec spacing if we have pie chart, otherwise tight_layout</span>
    <span class="k">if</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Manually adjust spacing for GridSpec layout with multiple 3D plots</span>
        <span class="n">gs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Create enhanced legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="n">create_class_legend</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">,</span> <span class="n">class_color_map</span><span class="p">,</span> <span class="n">class_names</span><span class="p">,</span> <span class="n">use_semantic_names</span><span class="p">)</span>
    <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">This visualization shows </span><span class="si">{</span><span class="n">n_views</span><span class="si">}</span><span class="s2"> different viewing angles of the same 3D t-SNE space:&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">):</span>
        <span class="n">view_name</span> <span class="o">=</span> <span class="n">view_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_names</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;View </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">- </span><span class="si">{</span><span class="n">view_name</span><span class="si">}</span><span class="s2">: Elevation=</span><span class="si">{</span><span class="n">elev</span><span class="si">}</span><span class="s2">°, Azimuth=</span><span class="si">{</span><span class="n">azim</span><span class="si">}</span><span class="s2">°&quot;</span>
    
    <span class="k">if</span> <span class="n">knn_info</span> <span class="ow">and</span> <span class="s1">&#39;knn_description&#39;</span> <span class="ow">in</span> <span class="n">knn_info</span> <span class="ow">and</span> <span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;knn_description&#39;</span><span class="p">]:</span>
        <span class="n">legend_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">knn_info</span><span class="p">[</span><span class="s1">&#39;knn_description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;n_train_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_test_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_classes&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_classes</span><span class="p">),</span>
        <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="n">unique_classes</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;highlighted_point&#39;</span><span class="p">:</span> <span class="n">highlight_test_idx</span><span class="p">,</span>
        <span class="s1">&#39;viewing_angles&#39;</span><span class="p">:</span> <span class="n">viewing_angles</span><span class="p">,</span>
        <span class="s1">&#39;n_views&#39;</span><span class="p">:</span> <span class="n">n_views</span><span class="p">,</span>
        <span class="s1">&#39;is_3d&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;knn_info&#39;</span><span class="p">:</span> <span class="n">knn_info</span><span class="p">,</span>
        <span class="s1">&#39;has_knn_pie_chart&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">knn_info</span> <span class="ow">and</span> <span class="n">ax_pie</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span> <span class="k">if</span> <span class="n">highlight_test_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;n_visible_train&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;train_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_tsne</span><span class="p">),</span>
        <span class="s1">&#39;n_visible_test&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne_visible</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;test_tsne_visible&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="encode_plot_as_base64">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.encode_plot_as_base64">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">encode_plot_as_base64</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode a matplotlib figure as a base64 string.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        fig: Matplotlib figure object</span>
<span class="sd">        format: Image format (&#39;png&#39;, &#39;jpg&#39;, etc.)</span>
<span class="sd">        dpi: Image resolution</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        base64_string: Base64 encoded image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Convert to base64</span>
    <span class="n">image_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">image_base64</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">save_plot_as_image</span><span class="p">(</span><span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">150</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a matplotlib figure as an image file.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        fig: Matplotlib figure object</span>
<span class="sd">        filepath: Path to save the image</span>
<span class="sd">        dpi: Image resolution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved plot to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="create_regression_color_map">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_regression_color_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_regression_color_map</span><span class="p">(</span><span class="n">target_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a discrete red-blue colormap for regression target values.</span>
<span class="sd">    </span>
<span class="sd">    Blue represents minimum values, red represents maximum values.</span>
<span class="sd">    Uses 20+ discrete levels for fine-grained VLM estimation.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        target_values: Array of target values</span>
<span class="sd">        colormap: Name of matplotlib colormap to use (default: &#39;RdBu_r&#39; for red-blue)</span>
<span class="sd">        n_levels: Number of discrete color levels (default: 20)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (normalized_values, colormap_object, vmin, vmax)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">target_values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="n">vmax</span><span class="p">:</span>
        <span class="c1"># Handle constant values</span>
        <span class="n">vmin</span> <span class="o">-=</span> <span class="mf">0.1</span>
        <span class="n">vmax</span> <span class="o">+=</span> <span class="mf">0.1</span>
    
    <span class="c1"># Normalize values to [0, 1] range</span>
    <span class="n">normalized_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
    
    <span class="c1"># Create discrete colormap with specified number of levels</span>
    <span class="n">base_cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">base_cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">))</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">colormap</span><span class="si">}</span><span class="s1">_discrete_</span><span class="si">{</span><span class="n">n_levels</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">normalized_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span></div>



<div class="viewcode-block" id="create_regression_tsne_visualization">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_regression_tsne_visualization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_regression_tsne_visualization</span><span class="p">(</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">perplexity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create t-SNE visualization for regression data with continuous color mapping.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_embeddings: Training embeddings [n_train, embedding_dim]</span>
<span class="sd">        train_targets: Training target values [n_train]</span>
<span class="sd">        test_embeddings: Test embeddings [n_test, embedding_dim]</span>
<span class="sd">        test_targets: Optional test target values [n_test]</span>
<span class="sd">        perplexity: t-SNE perplexity parameter</span>
<span class="sd">        n_iter: Number of t-SNE iterations</span>
<span class="sd">        random_state: Random seed for reproducibility</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        colormap: Matplotlib colormap name for target values</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        train_tsne: 2D t-SNE coordinates for training data [n_train, 2]</span>
<span class="sd">        test_tsne: 2D t-SNE coordinates for test data [n_test, 2]</span>
<span class="sd">        fig: Matplotlib figure object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating regression t-SNE visualization with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> train and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> test samples&quot;</span><span class="p">)</span>
    
    <span class="c1"># Combine embeddings for joint t-SNE</span>
    <span class="n">combined_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_embeddings</span><span class="p">,</span> <span class="n">test_embeddings</span><span class="p">])</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Adjust perplexity if needed based on data size</span>
    <span class="n">effective_perplexity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">perplexity</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">effective_perplexity</span> <span class="o">!=</span> <span class="n">perplexity</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusting perplexity from </span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2"> due to small dataset size&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply t-SNE</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running t-SNE with perplexity=</span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2">, n_iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
        <span class="n">n_components</span><span class="o">=</span><span class="mi">3</span> <span class="k">if</span> <span class="n">use_3d</span> <span class="k">else</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">perplexity</span><span class="o">=</span><span class="n">effective_perplexity</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Suppress numerical warnings during t-SNE computation</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;sklearn.utils.extmath&quot;</span><span class="p">)</span>
        <span class="n">tsne_results</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Split back into train and test</span>
    <span class="n">train_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
    <span class="n">test_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    
    <span class="c1"># Create visualization</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Create color mapping for target values</span>
    <span class="n">normalized_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">create_regression_color_map</span><span class="p">(</span><span class="n">train_targets</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
    
    <span class="c1"># Plot training points with color gradient based on target values</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="n">train_targets</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training Data&#39;</span>
    <span class="p">)</span>
    
    <span class="c1"># Add colorbar</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Target Value&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Plot test points in gray</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Test Points (Light Gray)&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>  <span class="c1"># Square markers for test points</span>
    <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t-SNE Visualization: Regression Data with Continuous Color Mapping&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Regression t-SNE visualization created successfully&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="create_regression_tsne_3d_visualization">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_regression_tsne_3d_visualization">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_regression_tsne_3d_visualization</span><span class="p">(</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_targets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">perplexity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
    <span class="n">n_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create 3D t-SNE visualization for regression data with continuous color mapping.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_embeddings: Training embeddings [n_train, embedding_dim]</span>
<span class="sd">        train_targets: Training target values [n_train]</span>
<span class="sd">        test_embeddings: Test embeddings [n_test, embedding_dim]</span>
<span class="sd">        test_targets: Optional test target values [n_test]</span>
<span class="sd">        perplexity: t-SNE perplexity parameter</span>
<span class="sd">        n_iter: Number of t-SNE iterations</span>
<span class="sd">        random_state: Random seed for reproducibility</span>
<span class="sd">        figsize: Figure size (width, height)</span>
<span class="sd">        colormap: Matplotlib colormap name for target values</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        train_tsne: 3D t-SNE coordinates for training data [n_train, 3]</span>
<span class="sd">        test_tsne: 3D t-SNE coordinates for test data [n_test, 3]</span>
<span class="sd">        fig: Matplotlib figure object with 3D subplots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating 3D regression t-SNE visualization with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> train and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_embeddings</span><span class="p">)</span><span class="si">}</span><span class="s2"> test samples&quot;</span><span class="p">)</span>
    
    <span class="c1"># Combine embeddings for joint t-SNE</span>
    <span class="n">combined_embeddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">train_embeddings</span><span class="p">,</span> <span class="n">test_embeddings</span><span class="p">])</span>
    <span class="n">n_train</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Adjust perplexity if needed based on data size</span>
    <span class="n">effective_perplexity</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">perplexity</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">effective_perplexity</span> <span class="o">!=</span> <span class="n">perplexity</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusting perplexity from </span><span class="si">{</span><span class="n">perplexity</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2"> due to small dataset size&quot;</span><span class="p">)</span>
    
    <span class="c1"># Apply 3D t-SNE</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running 3D t-SNE with perplexity=</span><span class="si">{</span><span class="n">effective_perplexity</span><span class="si">}</span><span class="s2">, n_iter=</span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span>
        <span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># 3D instead of 2D</span>
        <span class="n">perplexity</span><span class="o">=</span><span class="n">effective_perplexity</span><span class="p">,</span>
        <span class="n">max_iter</span><span class="o">=</span><span class="n">n_iter</span><span class="p">,</span>
        <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    
    <span class="c1"># Suppress numerical warnings during t-SNE computation</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;sklearn.utils.extmath&quot;</span><span class="p">)</span>
        <span class="n">tsne_results</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">combined_embeddings</span><span class="p">)</span>
    
    <span class="c1"># Split back into train and test</span>
    <span class="n">train_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[:</span><span class="n">n_train</span><span class="p">]</span>
    <span class="n">test_tsne</span> <span class="o">=</span> <span class="n">tsne_results</span><span class="p">[</span><span class="n">n_train</span><span class="p">:]</span>
    
    <span class="c1"># Create 3D visualization with multiple views</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Create color mapping for target values</span>
    <span class="n">normalized_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">create_regression_color_map</span><span class="p">(</span><span class="n">train_targets</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
    
    <span class="c1"># Define viewing angles: Isometric, Front (XZ), Side (YZ), Top (XY)</span>
    <span class="n">viewing_angles</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Isometric View&#39;</span><span class="p">,</span> <span class="s1">&#39;Front View (XZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Side View (YZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Top View (XY)&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">((</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">),</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">,</span> <span class="n">view_titles</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot training points with color gradient</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">train_targets</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="p">)</span>
        
        <span class="c1"># Plot test points in gray</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>
        <span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 1&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 2&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 3&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Add a single colorbar for all subplots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Target Value&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Add overall title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D t-SNE Visualization: Regression Data with Continuous Color Mapping&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;3D regression t-SNE visualization created successfully&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="create_combined_regression_tsne_plot">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_combined_regression_tsne_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_combined_regression_tsne_plot</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a combined t-SNE plot highlighting a specific test point for regression.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: Training t-SNE coordinates [n_train, 2]</span>
<span class="sd">        test_tsne: Test t-SNE coordinates [n_test, 2]</span>
<span class="sd">        train_targets: Training target values [n_train]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight</span>
<span class="sd">        figsize: Figure size</span>
<span class="sd">        zoom_factor: Zoom factor for the plot</span>
<span class="sd">        colormap: Matplotlib colormap name</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (figure, legend_text, metadata)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Create color mapping</span>
    <span class="n">normalized_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">create_regression_color_map</span><span class="p">(</span><span class="n">train_targets</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
    
    <span class="c1"># Plot training points with color gradient</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="n">train_targets</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Training Data&#39;</span>
    <span class="p">)</span>
    
    <span class="c1"># Plot non-highlighted test points</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">other_test_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">))</span> <span class="o">!=</span> <span class="n">highlight_test_idx</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne</span><span class="p">[</span><span class="n">other_test_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">other_test_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Other Test Points&#39;</span>
        <span class="p">)</span>
    
    <span class="c1"># Highlight the specific test point</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
        <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Query Point&#39;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
    <span class="p">)</span>
    
    <span class="c1"># Add colorbar</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Target Value&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Apply zoom</span>
    <span class="k">if</span> <span class="n">zoom_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">query_x</span><span class="p">,</span> <span class="n">query_y</span> <span class="o">=</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span>
        
        <span class="c1"># Calculate current axis limits</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Calculate new limits based on zoom factor</span>
        <span class="n">new_x_range</span> <span class="o">=</span> <span class="n">x_range</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        <span class="n">new_y_range</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">/</span> <span class="n">zoom_factor</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">query_x</span> <span class="o">-</span> <span class="n">new_x_range</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_x</span> <span class="o">+</span> <span class="n">new_x_range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">query_y</span> <span class="o">-</span> <span class="n">new_y_range</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_y</span> <span class="o">+</span> <span class="n">new_y_range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 1&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dimension 2&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;t-SNE: Regression Data with Query Point Highlighted&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    
    <span class="c1"># Create legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Legend: Training points colored by target value (</span><span class="si">{</span><span class="n">vmin</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">vmax</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">), test points in gray squares, query point as red star.&quot;</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;target_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>
        <span class="s1">&#39;colormap&#39;</span><span class="p">:</span> <span class="n">colormap</span><span class="p">,</span>
        <span class="s1">&#39;query_position&#39;</span><span class="p">:</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<span class="c1"># Placeholder functions for KNN-based regression visualizations</span>
<div class="viewcode-block" id="create_regression_tsne_plot_with_knn">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_regression_tsne_plot_with_knn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_regression_tsne_plot_with_knn</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create regression t-SNE plot with KNN connections showing target values.</span>
<span class="sd">    </span>
<span class="sd">    This is a placeholder that calls the base regression plot.</span>
<span class="sd">    Full KNN implementation would require adapting the KNN logic for regression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;KNN regression visualization not fully implemented yet, using base regression plot&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">create_combined_regression_tsne_plot</span><span class="p">(</span>
        <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">highlight_test_idx</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span> <span class="n">colormap</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="create_combined_regression_tsne_3d_plot">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_combined_regression_tsne_3d_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_combined_regression_tsne_3d_plot</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">viewing_angles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a combined 3D t-SNE plot highlighting a specific test point for regression.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        train_tsne: Training t-SNE coordinates [n_train, 3]</span>
<span class="sd">        test_tsne: Test t-SNE coordinates [n_test, 3]</span>
<span class="sd">        train_targets: Training target values [n_train]</span>
<span class="sd">        highlight_test_idx: Index of test point to highlight</span>
<span class="sd">        figsize: Figure size</span>
<span class="sd">        viewing_angles: List of (elevation, azimuth) tuples for viewing angles</span>
<span class="sd">        zoom_factor: Zoom factor for the plot</span>
<span class="sd">        colormap: Matplotlib colormap name</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (figure, legend_text, metadata)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
    <span class="c1"># Default viewing angles if not provided</span>
    <span class="k">if</span> <span class="n">viewing_angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">viewing_angles</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
    
    <span class="n">view_titles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Isometric View&#39;</span><span class="p">,</span> <span class="s1">&#39;Front View (XZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Side View (YZ)&#39;</span><span class="p">,</span> <span class="s1">&#39;Top View (XY)&#39;</span><span class="p">]</span>
    
    <span class="c1"># Create color mapping</span>
    <span class="n">normalized_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">create_regression_color_map</span><span class="p">(</span><span class="n">train_targets</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">((</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="p">),</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">viewing_angles</span><span class="p">,</span> <span class="n">view_titles</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        
        <span class="c1"># Plot training points with color gradient</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">train_tsne</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="n">train_targets</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="p">)</span>
        
        <span class="c1"># Plot non-highlighted test points</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">other_test_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_tsne</span><span class="p">))</span> <span class="o">!=</span> <span class="n">highlight_test_idx</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">other_test_mask</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">test_tsne</span><span class="p">[</span><span class="n">other_test_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
                    <span class="n">test_tsne</span><span class="p">[</span><span class="n">other_test_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
                    <span class="n">test_tsne</span><span class="p">[</span><span class="n">other_test_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                    <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span>
                <span class="p">)</span>
        
        <span class="c1"># Highlight the specific test point</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
            <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
            <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 1&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 2&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;t-SNE Dim 3&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">azim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="c1"># Add colorbar</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.92</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Target Value&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    
    <span class="c1"># Add overall title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D t-SNE: Regression Data with Query Point Highlighted&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    
    <span class="c1"># Create legend text</span>
    <span class="n">legend_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Legend: Training points colored by target value (</span><span class="si">{</span><span class="n">vmin</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">vmax</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2">), test points in gray squares, query point as red star.&quot;</span>
    
    <span class="c1"># Create metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;target_range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">),</span>
        <span class="s1">&#39;colormap&#39;</span><span class="p">:</span> <span class="n">colormap</span><span class="p">,</span>
        <span class="s1">&#39;query_position&#39;</span><span class="p">:</span> <span class="n">test_tsne</span><span class="p">[</span><span class="n">highlight_test_idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s1">&#39;viewing_angles&#39;</span><span class="p">:</span> <span class="n">viewing_angles</span><span class="p">,</span>
        <span class="s1">&#39;zoom_factor&#39;</span><span class="p">:</span> <span class="n">zoom_factor</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">legend_text</span><span class="p">,</span> <span class="n">metadata</span></div>



<div class="viewcode-block" id="create_regression_tsne_3d_plot_with_knn">
<a class="viewcode-back" href="../../../api-reference/clam.data.html#clam.data.tsne_visualization.create_regression_tsne_3d_plot_with_knn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_regression_tsne_3d_plot_with_knn</span><span class="p">(</span>
    <span class="n">train_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_tsne</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">train_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">test_embeddings</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">highlight_test_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
    <span class="n">viewing_angles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">zoom_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;RdBu_r&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create 3D regression t-SNE plot with KNN connections showing target values.</span>
<span class="sd">    </span>
<span class="sd">    This is a placeholder that calls the base 3D regression plot.</span>
<span class="sd">    Full KNN implementation would require adapting the KNN logic for regression.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;3D KNN regression visualization not fully implemented yet, using base 3D regression plot&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">create_combined_regression_tsne_3d_plot</span><span class="p">(</span>
        <span class="n">train_tsne</span><span class="p">,</span> <span class="n">test_tsne</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">,</span> <span class="n">highlight_test_idx</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">viewing_angles</span><span class="p">,</span> <span class="n">zoom_factor</span><span class="p">,</span> <span class="n">colormap</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, CLAM Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>